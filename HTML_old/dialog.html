<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Страница тикета</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .bg-primary {
            background-color: #154385;
        }
        .text-primary {
            color: #154385;
        }
        .bg-accent {
            background-color: #FFC107;
        }
        .text-accent {
            color: #FFC107;
        }
        .chat-message {
            background-color: #FFFFFF;
            border-radius: 8px;
            padding: 10px;
            max-width: 75%;
            border: 1px solid #E0E0E0;
        }
        .chat-message.mine {
            background-color: #154385;
            color: white;
            border: none;
        }
        .chat-input {
            background-color: #FFFFFF;
            border-radius: 8px;
            padding: 8px 16px;
            border: 2px solid #E0E0E0;
            margin-right: 0.5rem;
        }
        .file-input {
            visibility: hidden;
            position: absolute;
        }
    </style>
</head>

<body class="bg-[#F0F4FF] text-[#333333]">
    <div class="container mx-auto p-6">
        <!-- Заголовок и описание вопроса -->
        <div class="bg-white p-12 shadow-lg rounded-lg mb-6 flex justify-between">
            <div>
                <h1 class="text-2xl font-bold text-primary ">Тикет: Процедура поступления</h1>
                <p class="text-gray-700">Описание вопроса: Какие документы необходимы для поступления, и каковы сроки подачи заявок?</p>
            </div>
            <div class="">
                <button class="fab fa-xmark"></button>
            </div>
        </div>

        <!-- Область переписки -->
        <div class="bg-white p-12 shadow-lg rounded-lg mb-20">
            <h2 class="text-2xl font-bold text-primary mb-4">Переписка</h2>
            <div class="space-y-4 mb-4">
                <!-- Example Message from Student -->
                <div class="chat-message">
                    <p class="text-sm"><strong>Абитуриент:</strong> Какие документы необходимы для поступления?</p>
                </div>
                <!-- Example Message from Mentor -->
                <div class="chat-message mine float-right">
                    <p class="text-sm"><strong>Наставник:</strong> Вам потребуется аттестат, результаты ЕГЭ и другие документы, зависящие от программы.</p>
                </div>
                <div class="clear-both"></div>
            </div>
            <div class="flex items-center">
                <input id="chat-message-input" type="text" placeholder="Введите ваше сообщение..." class="chat-input flex-1">
                <label for="file-upload" class="bg-accent text-white px-4 py-2 rounded-full hover:bg-yellow-600 cursor-pointer mr-2">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input id="file-upload" type="file" class="file-input">
                <button id="chat-message-submit" class="bg-accent text-white px-6 py-2 rounded-full hover:bg-yellow-600">
                    <i class="fas fa-paper-plane"></i> Отправить
                </button>
            </div>
        </div>
    </div>

    <script>
        const ticketId = '{{ ticket.id }}'; // Получите ID тикета из контекста
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(
            wsScheme + '://'
            + window.location.host
            + '/ws/chat/'
            + ticketId
            + '/'
        );
    
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            const user = data.user;
    
            // Добавляем сообщение в область переписки
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('chat-message');
            if (user === '{{ user.username }}') {
                messageContainer.classList.add('mine', 'float-right');
            }
    
            const messageContent = document.createElement('p');
            messageContent.classList.add('text-sm');
            messageContent.innerHTML = `<strong>${user}:</strong> ${message}`;
    
            messageContainer.appendChild(messageContent);
    
            const chatArea = document.querySelector('.space-y-4');
            chatArea.appendChild(messageContainer);
    
            // Прокручиваем вниз
            chatArea.scrollTop = chatArea.scrollHeight;
        };
    
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    
        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // Нажатие Enter
                document.querySelector('#chat-message-submit').click();
            }
        };
    
        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
    </script>
</body>

</html>